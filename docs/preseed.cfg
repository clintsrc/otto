# Target disk
d-i partman-auto/disk string /dev/nvme0n1

# Remove old LVM and RAID metadata
d-i partman-lvm/device_remove_lvm boolean true
d-i partman-md/device_remove_md boolean true

# Use LUKS + LVM method
d-i partman-auto/method string crypto

# Provide LUKS passphrase (replace 'yourpass' with secure passphrase)
d-i partman-crypto/passphrase password yourpass
d-i partman-crypto/passphrase-again password yourpass
d-i partman-crypto/erase_disks boolean true

# Partitioning recipe
d-i partman-auto/expert_recipe string \
  lvmluks :: \
    512 512 512 fat32 $primary{ } $bootable{ } $esp{ } method{ format } format{ } \
      use_filesystem{ } filesystem{ vfat } mountpoint{ /boot/efi } . \
    550 550 550 ext2 method{ format } format{ } \
      use_filesystem{ } filesystem{ ext2 } mountpoint{ /boot } . \
    1 1 max crypto method{ crypto } encrypted{ } encryption_lvm{ } vg_name{ vg_system } . \
    20000 20000 20000 ext4 $lvmok{ } in_vg{ vg_system } lv_name{ lv_root } method{ format } format{ } \
      use_filesystem{ } filesystem{ ext4 } mountpoint{ / } . \
    2000 2000 2000 linux-swap $lvmok{ } in_vg{ vg_system } lv_name{ lv_swap } method{ swap } format{ } . \
    1 1 -1 ext4 $lvmok{ } in_vg{ vg_system } lv_name{ lv_home } method{ format } format{ } \
      use_filesystem{ } filesystem{ ext4 } mountpoint{ /home } .

# Select and confirm
d-i partman-auto/choose_recipe select lvmluks
d-i partman-auto/confirm boolean true
d-i partman-auto/confirm_nooverwrite boolean true

d-i partman-partitioning/confirm_write_new_label boolean true
d-i partman/choose_partition select finish
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true

d-i partman-lvm/confirm boolean true
d-i partman-lvm/confirm_nooverwrite boolean true
