# 1. Script requires UEFI mode. Check with command:
#    $ [ -d /sys/firmware/efi ] && echo "UEFI mode detected" || echo "Legacy BIOS mode detected"
# 2. Place this script in the root of the USB installer

# Select disk to partition
d-i partman-auto/disk string /dev/sda

# Use expert recipe for custom partitions
d-i partman-auto/expert_recipe string                         \
  custom-luks ::                                              \
    512 512 512 fat32                                         \
      $primary{ } $bootable{ }                                \
      method{ efi } format{ }                                 \
      mountpoint{ /boot/efi }                                 \
      .                                                       \
    550 550 550 ext4                                          \
      $primary{ }                                            \
      method{ format } format{ }                             \
      mountpoint{ /boot }                                    \
      .                                                       \
    10000 1000000000 -                                        \
      $primary{ }                                            \
      method{ crypto } format{ } luksformat{ }               \
      luksoptions{ }                                         \
      .                                                       \

# Choose the expert recipe defined above
d-i partman-auto/choose_recipe select custom-luks

# Tell partitioner to use crypto (LUKS) method
d-i partman-auto/method string crypto

# Provide the LUKS passphrase (replace with your secure passphrase, or comment out to prompt)
# d-i partman-crypto/passphrase password yourpassphrase
# d-i partman-crypto/passphrase-again password yourpassphrase

# Wipe any existing LVM volumes on the disk (optional but recommended)
d-i partman-lvm/device_remove_lvm boolean true

# Confirm partitioning and formatting steps automatically
d-i partman-partitioning/confirm_write_new_label boolean true
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true
d-i partman/choose_partition select finish

# Skip automatic LVM setup, as it will be done manually after unlocking LUKS
d-i partman-auto-lvm/grow lv_root boolean false

# Preseed late command: open encrypted partition, create LVM VG + LVs, format, mount

d-i preseed/late_command string \
  in-target /bin/bash -c "cryptsetup luksOpen /dev/sda3 luks_disk"; \
  in-target /sbin/vgcreate vg_main /dev/mapper/luks_disk; \
  in-target /sbin/lvcreate -L 60G -n lv_root vg_main; \
  in-target /sbin/lvcreate -L 50G -n lv_recovery vg_main; \
  in-target /sbin/lvcreate -L 16G -n lv_swap vg_main; \
  in-target /sbin/lvcreate -l 100%FREE -n lv_home vg_main; \
  in-target /bin/mkfs.btrfs /dev/vg_main/lv_root; \
  in-target /bin/mkfs.ext4 /dev/vg_main/lv_recovery; \
  in-target /sbin/mkswap /dev/vg_main/lv_swap; \
  in-target /bin/mount /dev/vg_main/lv_root /target; \
  in-target /bin/mkdir -p /target/mnt/recovery; \
  in-target /bin/mount /dev/vg_main/lv_recovery /target/mnt/recovery; \
  in-target /bin/mkdir -p /target/home; \
  in-target /bin/mount /dev/vg_main/lv_home /target/home; \
  in-target /sbin/swapon /dev/vg_main/lv_swap; \
  # Write crypttab and fstab so system boots properly (this requires scripting, see notes below)
