# 1. Script requires UEFI mode. Check with command:
#    $ [ -d /sys/firmware/efi ] && echo "UEFI mode detected" || echo "Legacy BIOS mode detected"
# 2. Place this script in the root of the USB installer

# Select disk to partition
d-i partman-auto/disk string /dev/sda

# Use expert recipe for custom partitions
d-i partman-auto/expert_recipe string                         \
  custom-luks-lvm ::                                          \
    512 512 512 fat32                                         \
      $primary{ } $bootable{ }                                \
      method{ efi } format{ }                                 \
      mountpoint{ /boot/efi }                                 \
      .                                                       \
    550 550 550 ext4                                          \
      $primary{ }                                            \
      method{ format } format{ }                             \
      mountpoint{ /boot }                                    \
      .                                                       \
    10000 1000000000 -                                         \
      $primary{ }                                            \
      method{ crypto } format{ } luksformat{ }               \
      luksoptions{ }                                         \
      .                                                       \

# Choose the expert recipe defined above
d-i partman-auto/choose_recipe select custom-luks-lvm

# Tell partitioner to use crypto (LUKS) method
d-i partman-auto/method string crypto

# Provide the LUKS passphrase (replace with your secure passphrase, or comment out to prompt)
# d-i partman-crypto/passphrase password yourpassphrase
# d-i partman-crypto/passphrase-again password yourpassphrase

# Wipe any existing LVM volumes on the disk (optional but recommended)
d-i partman-lvm/device_remove_lvm boolean true

# Confirm partitioning and formatting steps automatically
d-i partman-partitioning/confirm_write_new_label boolean true
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true
d-i partman/choose_partition select finish

# Create a new LVM volume group with a fixed generic name
d-i partman-auto-lvm/new_vg_name string vg_main

# Create a logical volume named lv_root with size 60GB
d-i partman-auto-lvm/new_lv_name string lv_root
d-i partman-auto-lvm/new_lv_size string 60G

# Don't grow lv_root beyond 60GB
d-i partman-auto-lvm/grow lv_root boolean false

# Format lv_root with btrfs and mount it as root
d-i partman-auto-lvm/format_lv string btrfs
d-i partman-auto-lvm/mount_lv string /

# Ensure all confirmations are accepted
d-i partman-lvm/confirm boolean true
d-i partman-lvm/confirm_nooverwrite boolean true
